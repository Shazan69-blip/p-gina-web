<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario | Grupo Fe</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='color de formulario.css') }}">
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <img src="{{ url_for('static', filename='logo de arriba.png') }}" alt="Logo" class="logo-img">
      <h1></h1>
    </div>

    <button class="menu-toggle" id="menuToggle">‚ò∞</button>

    <nav>
      <ul id="navMenu">
        <li><a href="/">Inicio</a></li>
        <li><a href="/acerca">Acerca de nosotros</a></li>
        <li><a href="/servicios">Servicios</a></li>
        <li><a class="activo" href="/formulario">Formulario</a></li>
        <li><a href="/contacto">Contacto</a></li>
      </ul>
    </nav>
  </header>

  <div class="nav-overlay" id="navOverlay"></div>

  <main class="contenedor">
    <h2>Formulario de aplicaci√≥n al Bono Familiar de Vivienda ‚Äì Art√≠culo 59 (Ley 7052)</h2>

    <div class="top-actions">
      <a class="btn btn-gold" href="{{ url_for('static', filename='Formulario_Beneficiario_Art59_GrupoFe.docx') }}" download>
        üìÑ Descargar formulario (.docx)
      </a>
      <button id="btn-fill-online" class="btn btn-outline">üñäÔ∏è Llenar en l√≠nea</button>
    </div>

    <form id="mainForm" class="formulario" action="/enviar-formulario" method="POST">
      <!-- (todo tu formulario se mantiene igual) -->

      <!-- 1. Datos del Beneficiario Principal -->
      <section class="card">
        <h3>1. Datos del Beneficiario Principal</h3>
        <label>Nombre completo:<input type="text" name="beneficiario_nombre" required></label>
        <label>N√∫mero de c√©dula:<input type="text" name="beneficiario_cedula" required></label>
        <label>Tel√©fono:<input type="tel" name="beneficiario_telefono" required></label>
        <label>Correo electr√≥nico:<input type="email" name="beneficiario_email" required></label>
        <label>Estado civil:
          <select name="beneficiario_estado_civil" id="estadoCivil" required>
            <option value="">Seleccione...</option>
            <option value="Soltero">Soltero</option>
            <option value="Casado">Casado</option>
            <option value="Divorciado">Divorciado</option>
            <option value="Viudo">Viudo</option>
            <option value="Separado">Separado</option>
            <option value="Union Libre">Uni√≥n Libre</option>
          </select>
        </label>
        <div id="tiempoUnionWrapper" style="display:none;">
          <label>Tiempo de uni√≥n (meses/a√±os):<input type="text" name="beneficiario_tiempo_union" placeholder="Ej: 3 a√±os"></label>
        </div>
        <label>Nacionalidad:<input type="text" name="beneficiario_nacionalidad"></label>
        <label>Escolaridad:<input type="text" name="beneficiario_escolaridad"></label>
        <label>Direcci√≥n exacta de residencia actual:<textarea name="beneficiario_direccion" rows="2"></textarea></label>
        <div class="row">
          <label>Provincia:<input type="text" name="beneficiario_provincia"></label>
          <label>Cant√≥n:<input type="text" name="beneficiario_canton"></label>
          <label>Distrito:<input type="text" name="beneficiario_distrito"></label>
        </div>
        <label>Barrio:<input type="text" name="beneficiario_barrio"></label>
      </section>

      <!-- 2. Composici√≥n del Grupo Familiar -->
      <section class="card">
        <h3>2. Composici√≥n del Grupo Familiar</h3>
        <p>Indique todos los miembros del grupo familiar que habitar√°n la vivienda (hasta 12)</p>
        <div id="familyList">
          <div class="family-row">
            <input type="text" name="f_nombre[]" placeholder="Nombre">
            <input type="text" name="f_parentesco[]" placeholder="Parentesco">
            <input type="number" name="f_edad[]" placeholder="Edad" min="0">
            <input type="text" name="f_ocupacion[]" placeholder="Ocupaci√≥n">
            <input type="number" name="f_ingreso[]" placeholder="Ingreso mensual (‚Ç°)" min="0">
            <button type="button" class="small-btn remove-row" title="Eliminar">‚úñ</button>
          </div>
        </div>
        <div class="row-actions">
          <button type="button" id="addMember" class="btn">+ Agregar miembro</button>
          <small class="muted">Puedes agregar hasta 12 miembros</small>
        </div>
        <label>¬øExiste alg√∫n miembro en estado de gestaci√≥n?
          <select name="gestacion_existe" id="gestacion">
            <option value="No">No</option>
            <option value="Si">S√≠</option>
          </select>
        </label>
        <div id="gestacionMeses" style="display:none;">
          <label>Meses de gestaci√≥n:<input type="number" name="gestacion_meses" min="0"></label>
        </div>
        <label>¬øAlg√∫n miembro con discapacidad?
          <select name="discapacidad_existe" id="discapacidad">
            <option value="No">No</option>
            <option value="Si">S√≠</option>
          </select>
        </label>
        <div id="discapacidadDetalle" style="display:none;">
          <label>Explique:<textarea name="discapacidad_detalle" rows="3"></textarea></label>
        </div>
      </section>

      <!-- 3. Informaci√≥n Socioecon√≥mica -->
      <section class="card">
        <h3>3. Informaci√≥n Socioecon√≥mica</h3>
        <label>Actividad econ√≥mica principal del beneficiario:<input type="text" name="actividad_economica"></label>
        <label>Tiempo de laborar:<input type="text" name="tiempo_laborar" placeholder="Ej: 5 a√±os"></label>
        <label>Cotiza en la CCSS:
          <select name="cotiza_ccss">
            <option>Si</option>
            <option>No</option>
          </select>
        </label>
        <label>Ingreso mensual familiar total (‚Ç°):<input type="number" name="ingreso_mensual" min="0"></label>
        <label>¬øRecibe alg√∫n subsidio o ayuda estatal?
          <select name="recibe_subsidio">
            <option>No</option>
            <option>Si</option>
          </select>
        </label>
        <label>¬øCu√°l?:<input type="text" name="cual_subsidio"></label>
        <label>Recibe pensi√≥n alimentaria:
          <select name="recibe_pension">
            <option>No</option>
            <option>Si</option>
          </select>
        </label>
        <label>Voluntaria / Obligatoria:
          <select name="pension_tipo">
            <option>Voluntaria</option>
            <option>Obligatoria</option>
          </select>
        </label>
        <label>Monto pensi√≥n alimentaria (‚Ç°):<input type="number" name="pension_monto" min="0"></label>
        <label>¬øPosee veh√≠culo?
          <select name="posee_vehiculo">
            <option>No</option>
            <option>Si</option>
          </select>
        </label>
        <label>Marca/Modelo:<input type="text" name="vehiculo_marca_modelo"></label>
      </section>

      <!-- 4. Informaci√≥n del Proyecto o Lote -->
      <section class="card">
        <h3>4. Informaci√≥n del Proyecto o Lote</h3>
        <label>Nombre del proyecto:<input type="text" name="proyecto_nombre"></label>
        <label>Ubicaci√≥n exacta del lote o vivienda:<textarea name="proyecto_ubicacion" rows="2"></textarea></label>
        <label>N√∫mero de lote / identificaci√≥n catastral:<input type="text" name="proyecto_numero_lote"></label>
        <label>Propietario del terreno:<input type="text" name="propietario_terreno"></label>
        <label>N√∫mero de c√©dula del vendedor:<input type="text" name="vendedor_cedula"></label>
        <label>Tel√©fono del vendedor:<input type="tel" name="vendedor_telefono"></label>
        <label>Direcci√≥n del vendedor:<input type="text" name="vendedor_direccion"></label>
        <label>Monto del terreno (‚Ç°):<input type="number" name="monto_terreno" min="0"></label>
        <label>Sistema constructivo:
          <div class="checkbox-group">
            <label><input type="checkbox" name="sistema_constructivo_prefablock" checked> Prefablock</label>
            <label><input type="checkbox" name="sistema_constructivo_otro"> Otro</label>
            <input type="text" name="sistema_constructivo_otro_text" placeholder="Si 'Otro', especifique">
          </div>
        </label>
        <label>Tipo de vivienda:
          <div class="radio-group">
            <label><input type="radio" name="tipo_vivienda" value="Nueva" checked> Nueva</label>
            <label><input type="radio" name="tipo_vivienda" value="Ampliacion"> Ampliaci√≥n</label>
            <label><input type="radio" name="tipo_vivienda" value="Reparacion"> Reparaci√≥n</label>
          </div>
        </label>
      </section>

      <!-- 5. Declaraci√≥n Jurada -->
      <section class="card">
        <h3>5. Declaraci√≥n Jurada del Beneficiario</h3>
        <p>Declaro bajo juramento que la informaci√≥n suministrada es veraz y completa.</p>
        <label>Firma del Beneficiario:<input type="text" name="firma_beneficiario"></label>
        <label>Fecha:<input type="date" name="firma_fecha"></label>
      </section>

      <!-- 6. Uso Exclusivo de Grupo Fe -->
      <section class="card">
        <h3>6. Uso Exclusivo de Grupo Fe</h3>
        <label>Verificaci√≥n social realizada por:<input type="text" name="verificacion_social_por"></label>
        <label>Fecha verificaci√≥n social:<input type="date" name="verificacion_social_fecha"></label>
        <label>Verificaci√≥n t√©cnica realizada por:<input type="text" name="verificacion_tecnica_por"></label>
        <label>Fecha verificaci√≥n t√©cnica:<input type="date" name="verificacion_tecnica_fecha"></label>
        <label>Observaciones:<textarea name="observaciones" rows="3"></textarea></label>
      </section>

      <div class="form-actions">
        <button type="submit" class="btn btn-gold">Enviar formulario</button>
      </div>

    </form>

    <footer class="foot">
      <small>Documento de uso interno ‚Äì Grupo Fe Constructora de Vivienda de Inter√©s Social</small>
    </footer>
  </main>

  <script>
  // ======= MENU MOBILE (mantener comportamiento actual) =======
  const menuToggle = document.getElementById('menuToggle');
  const navMenu = document.getElementById('navMenu');
  const navOverlay = document.getElementById('navOverlay');

  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      navMenu.classList.toggle('active');
      navOverlay.classList.toggle('active');
    });
    navOverlay.addEventListener('click', () => {
      navMenu.classList.remove('active');
      navOverlay.classList.remove('active');
    });
  }

  // ======= FUNCION: recoger campos y generar PDF limpio por secciones =======
  document.getElementById('mainForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    const left = 40;
    let y = 60;
    const lineHeight = 14;
    const pageHeight = doc.internal.pageSize.height - 40;

    // Helper: salto de l√≠nea y nueva p√°gina si hace falta
    function ensureSpace(linesNeeded = 1) {
      if (y + (linesNeeded * lineHeight) > pageHeight) {
        doc.addPage();
        y = 60;
      }
    }

    // Helper: escribe l√≠neas (texto o array de l√≠neas)
    function write(text) {
      const lines = Array.isArray(text) ? text : doc.splitTextToSize(String(text), doc.internal.pageSize.width - left - 40);
      ensureSpace(lines.length);
      doc.text(lines, left, y);
      y += lines.length * lineHeight;
    }

    // Recolectar datos (ordenados por secciones)
    const form = this;

    // 1. Datos del Beneficiario Principal
    write("1. Datos del Beneficiario Principal");
    write("-----------------------------------");
    const b_nombre = form.querySelector('[name="beneficiario_nombre"]')?.value || '';
    const b_cedula = form.querySelector('[name="beneficiario_cedula"]')?.value || '';
    const b_telefono = form.querySelector('[name="beneficiario_telefono"]')?.value || '';
    const b_email = form.querySelector('[name="beneficiario_email"]')?.value || '';
    const b_estado = form.querySelector('[name="beneficiario_estado_civil"]')?.value || '';
    const b_tiempo_union = form.querySelector('[name="beneficiario_tiempo_union"]')?.value || '';
    const b_nacionalidad = form.querySelector('[name="beneficiario_nacionalidad"]')?.value || '';
    const b_escolaridad = form.querySelector('[name="beneficiario_escolaridad"]')?.value || '';
    const b_direccion = form.querySelector('[name="beneficiario_direccion"]')?.value || '';
    const b_provincia = form.querySelector('[name="beneficiario_provincia"]')?.value || '';
    const b_canton = form.querySelector('[name="beneficiario_canton"]')?.value || '';
    const b_distrito = form.querySelector('[name="beneficiario_distrito"]')?.value || '';
    const b_barrio = form.querySelector('[name="beneficiario_barrio"]')?.value || '';

    write(`Nombre completo: ${b_nombre}`);
    write(`C√©dula: ${b_cedula}`);
    write(`Tel√©fono: ${b_telefono}`);
    write(`Correo: ${b_email}`);
    write(`Estado civil: ${b_estado}`);
    if (b_tiempo_union) write(`Tiempo de uni√≥n: ${b_tiempo_union}`);
    write(`Nacionalidad: ${b_nacionalidad}`);
    write(`Escolaridad: ${b_escolaridad}`);
    write(`Direcci√≥n: ${b_direccion}`);
    write(`Provincia: ${b_provincia} | Cant√≥n: ${b_canton} | Distrito: ${b_distrito}`);
    write(`Barrio: ${b_barrio}`);
    write(" ");

    // 2. Composici√≥n del Grupo Familiar
    write("2. Composici√≥n del Grupo Familiar");
    write("---------------------------------");
    // obtener arrays de miembros
    const nombres = Array.from(form.querySelectorAll('input[name="f_nombre[]"]')).map(i => i.value).filter(v=>v);
    const parentescos = Array.from(form.querySelectorAll('input[name="f_parentesco[]"]')).map(i => i.value);
    const edades = Array.from(form.querySelectorAll('input[name="f_edad[]"]')).map(i => i.value);
    const ocupaciones = Array.from(form.querySelectorAll('input[name="f_ocupacion[]"]')).map(i => i.value);
    const ingresos = Array.from(form.querySelectorAll('input[name="f_ingreso[]"]')).map(i => i.value);

    if (nombres.length === 0) {
      write("No se ingresaron miembros del grupo familiar.");
    } else {
      nombres.forEach((nm, idx) => {
        const p = parentescos[idx] || '';
        const e = edades[idx] || '';
        const o = ocupaciones[idx] || '';
        const ing = ingresos[idx] || '';
        write(`${idx + 1}. ${nm} ‚Äî Parentesco: ${p} | Edad: ${e} | Ocupaci√≥n: ${o} | Ingreso: ${ing}`);
      });
    }
    write(" ");

    // Gestaci√≥n / discapacidad
    const gestacion = form.querySelector('[name="gestacion_existe"]')?.value || '';
    const gest_meses = form.querySelector('[name="gestacion_meses"]')?.value || '';
    const discapacidad = form.querySelector('[name="discapacidad_existe"]')?.value || '';
    const discapacidad_detalle = form.querySelector('[name="discapacidad_detalle"]')?.value || '';

    write(`Existe miembro en gestaci√≥n: ${gestacion}${gestacion === 'Si' && gest_meses ? ` (Meses: ${gest_meses})` : ''}`);
    write(`Alg√∫n miembro con discapacidad: ${discapacidad}${discapacidad === 'Si' && discapacidad_detalle ? ` (Detalle: ${discapacidad_detalle})` : ''}`);
    write(" ");

    // 3. Informaci√≥n Socioecon√≥mica
    write("3. Informaci√≥n Socioecon√≥mica");
    write("-----------------------------");
    const actividad = form.querySelector('[name="actividad_economica"]')?.value || '';
    const tiempo_lab = form.querySelector('[name="tiempo_laborar"]')?.value || '';
    const cotiza = form.querySelector('[name="cotiza_ccss"]')?.value || '';
    const ingreso_total = form.querySelector('[name="ingreso_mensual"]')?.value || '';
    const recibe_sub = form.querySelector('[name="recibe_subsidio"]')?.value || '';
    const cual_sub = form.querySelector('[name="cual_subsidio"]')?.value || '';
    const recibe_pension = form.querySelector('[name="recibe_pension"]')?.value || '';
    const pension_tipo = form.querySelector('[name="pension_tipo"]')?.value || '';
    const pension_monto = form.querySelector('[name="pension_monto"]')?.value || '';
    const posee_vehiculo = form.querySelector('[name="posee_vehiculo"]')?.value || '';
    const marca_modelo = form.querySelector('[name="vehiculo_marca_modelo"]')?.value || '';

    write(`Actividad econ√≥mica: ${actividad}`);
    write(`Tiempo laborando: ${tiempo_lab}`);
    write(`Cotiza en CCSS: ${cotiza}`);
    write(`Ingreso mensual familiar total (‚Ç°): ${ingreso_total}`);
    write(`Recibe subsidio: ${recibe_sub}${recibe_sub === 'Si' ? ` (Cu√°l: ${cual_sub})` : ''}`);
    write(`Recibe pensi√≥n alimentaria: ${recibe_pension} (${pension_tipo}) ‚Äî Monto: ${pension_monto}`);
    write(`Posee veh√≠culo: ${posee_vehiculo} ‚Äî Marca/Modelo: ${marca_modelo}`);
    write(" ");

    // 4. Informaci√≥n del Proyecto o Lote
    write("4. Informaci√≥n del Proyecto o Lote");
    write("----------------------------------");
    const proyecto_nombre = form.querySelector('[name="proyecto_nombre"]')?.value || '';
    const proyecto_ubicacion = form.querySelector('[name="proyecto_ubicacion"]')?.value || '';
    const proyecto_numero = form.querySelector('[name="proyecto_numero_lote"]')?.value || '';
    const propietario = form.querySelector('[name="propietario_terreno"]')?.value || '';
    const vendedor_ced = form.querySelector('[name="vendedor_cedula"]')?.value || '';
    const vendedor_tel = form.querySelector('[name="vendedor_telefono"]')?.value || '';
    const vendedor_dir = form.querySelector('[name="vendedor_direccion"]')?.value || '';
    const monto_terreno = form.querySelector('[name="monto_terreno"]')?.value || '';
    const sistema_prefab = form.querySelector('[name="sistema_constructivo_prefablock"]')?.checked ? 'Prefablock' : '';
    const sistema_otro = form.querySelector('[name="sistema_constructivo_otro"]')?.checked ? (form.querySelector('[name="sistema_constructivo_otro_text"]')?.value || 'Otro') : '';
    const tipo_vivienda = form.querySelector('input[name="tipo_vivienda"]:checked')?.value || '';

    write(`Nombre del proyecto: ${proyecto_nombre}`);
    write(`Ubicaci√≥n: ${proyecto_ubicacion}`);
    write(`N√∫mero de lote / catastral: ${proyecto_numero}`);
    write(`Propietario del terreno: ${propietario}`);
    write(`Vendedor - C√©dula: ${vendedor_ced} | Tel: ${vendedor_tel} | Dir: ${vendedor_dir}`);
    write(`Monto del terreno (‚Ç°): ${monto_terreno}`);
    write(`Sistema constructivo: ${[sistema_prefab, sistema_otro].filter(Boolean).join(', ')}`);
    write(`Tipo de vivienda: ${tipo_vivienda}`);
    write(" ");

    // 5. Declaraci√≥n Jurada
    write("5. Declaraci√≥n Jurada del Beneficiario");
    write("-------------------------------------");
    const firma = form.querySelector('[name="firma_beneficiario"]')?.value || '';
    const fecha_firma = form.querySelector('[name="firma_fecha"]')?.value || '';
    write(`Firma: ${firma}`);
    write(`Fecha: ${fecha_firma}`);
    write(" ");

    // 6. Uso Exclusivo
    write("6. Uso Exclusivo de Grupo Fe");
    write("----------------------------");
    const ver_social_por = form.querySelector('[name="verificacion_social_por"]')?.value || '';
    const ver_social_fecha = form.querySelector('[name="verificacion_social_fecha"]')?.value || '';
    const ver_tecnica_por = form.querySelector('[name="verificacion_tecnica_por"]')?.value || '';
    const ver_tecnica_fecha = form.querySelector('[name="verificacion_tecnica_fecha"]')?.value || '';
    const observaciones = form.querySelector('[name="observaciones"]')?.value || '';

    write(`Verificaci√≥n social por: ${ver_social_por}`);
    write(`Fecha verificaci√≥n social: ${ver_social_fecha}`);
    write(`Verificaci√≥n t√©cnica por: ${ver_tecnica_por}`);
    write(`Fecha verificaci√≥n t√©cnica: ${ver_tecnica_fecha}`);
    write(`Observaciones: ${observaciones}`);

    // -------------- FIN CONTENIDO PDF --------------

    // Nombre del archivo con el nombre del beneficiario (sanitizado)
    const nombreArchivoBase = b_nombre ? b_nombre.replace(/[^a-zA-Z0-9_\- ]/g, '').trim().replace(/\s+/g, "_") : "Beneficiario";
    const filename = `Formulario_GrupoFe_${nombreArchivoBase}.pdf`;

    // Guardar / descargar PDF
    doc.save(filename);

    // Esperar un poco para dar tiempo a que comience la descarga y luego abrir Gmail
    setTimeout(() => {
      const destinatario = "informaciongrupofe@gmail.com";
      const asunto = encodeURIComponent("Formulario Bono Familiar de Vivienda ‚Äì Grupo Fe");
      const cuerpo = encodeURIComponent("Adjunto el formulario de aplicaci√≥n al Bono Familiar de Vivienda.\n\nSaludos.");
      // Abrir Gmail (en nueva pesta√±a)
      window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${destinatario}&su=${asunto}&body=${cuerpo}`, '_blank');
    }, 800);

  });
  </script>
  <script src="{{ url_for('static', filename='formulario.js') }}"></script>
</body>
</html>
